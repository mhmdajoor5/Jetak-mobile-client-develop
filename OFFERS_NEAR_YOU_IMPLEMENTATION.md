# تطوير قسم "العروض القريبة" في صفحة الـ Home

## نظرة عامة
تم تطوير قسم "offers near you" في صفحة الـ home ليعرض المطاعم القريبة التي لديها عروض بناءً على المسافة من موقع المستخدم.

## التغييرات المطبقة

### 1. تعديل HomeController (`lib/src/controllers/home_controller.dart`)

#### إضافة متغيرات جديدة:
```dart
// إضافة متغيرات للمطاعم القريبة التي لديها عروض
List<Restaurant> nearbyOffers = <Restaurant>[];
bool isLoadingNearbyOffers = false;
```

#### إضافة دالة `getNearbyOffers()`:
- تجلب موقع المستخدم الحالي
- تستدعي `getNearRestaurants()` للحصول على المطاعم القريبة
- تصفي المطاعم التي لديها عروض بناءً على:
  - وجود كوبون صالح (`coupon.valid == true`)
  - وجود خصم (`coupon.discount > 0`)
  - وجود عروض قابلة للخصم (`discountables.isNotEmpty`)
- ترتب المطاعم حسب المسافة (الأقرب أولاً)

#### تحديث `loadAllData()`:
- إضافة استدعاء `getNearbyOffers()` في `Future.wait()`
- تخزين النتائج في `nearbyOffers`

#### تحديث `refreshHome()`:
- إضافة مسح `nearbyOffers` عند تحديث البيانات

### 2. تعديل OffersNearYouPage (`lib/src/pages/Home/OffersNearYouPage.dart`)

#### تحسين عرض البيانات:
- إضافة حالة التحميل مع مؤشر دائري
- عرض المطاعم التي لديها عروض من `_con.nearbyOffers`
- إضافة رسالة عندما لا توجد عروض قريبة
- تحسين تجربة المستخدم مع رسائل واضحة

### 3. تعديل HomeTopRestaurantsSection (`lib/src/pages/Home/home_top_restaurants_section.dart`)

#### إضافة معاملات جديدة:
```dart
final bool isLoading;
final bool showOffers;
```

#### تحسين العرض:
- إضافة حالة التحميل
- عرض المطاعم التي لديها عروض
- إضافة رسالة عندما لا توجد عروض
- تحسين التصميم والرسائل

### 4. تعديل الصفحة الرئيسية (`lib/src/pages/bottom_nav_bar_modules/home.dart`)

#### تحديث قسم "top_restaurants":
```dart
HomeTopRestaurantsSection(
  restaurants: _con.nearbyOffers,
  isLoading: _con.isLoadingNearbyOffers,
  showOffers: true,
),
```

## الميزات الجديدة

### 1. تصفية المطاعم حسب العروض
- يتم تصفية المطاعم القريبة ليعرض فقط تلك التي لديها عروض
- التحقق من صحة الكوبونات والخصومات

### 2. ترتيب حسب المسافة
- المطاعم الأقرب تظهر أولاً
- تحسين تجربة المستخدم

### 3. حالات العرض المختلفة
- **حالة التحميل**: مؤشر دائري مع رسالة "جاري البحث عن العروض القريبة..."
- **عرض المطاعم**: عرض المطاعم التي لديها عروض
- **لا توجد عروض**: رسالة واضحة مع أيقونة مناسبة

### 4. تحديث تلقائي
- عند تحديث الصفحة، يتم إعادة جلب العروض القريبة
- تحديث البيانات بناءً على الموقع الحالي

## كيفية عمل النظام

1. **جلب الموقع**: يتم الحصول على موقع المستخدم الحالي
2. **جلب المطاعم القريبة**: استدعاء API لجلب المطاعم القريبة
3. **تصفية العروض**: تصفية المطاعم التي لديها عروض صالحة
4. **ترتيب حسب المسافة**: ترتيب النتائج من الأقرب إلى الأبعد
5. **عرض النتائج**: عرض المطاعم في واجهة المستخدم

## التحسينات المستقبلية

1. **إضافة فلترة إضافية**: حسب نوع العروض أو قيمة الخصم
2. **تحسين الأداء**: تخزين مؤقت للبيانات
3. **إضافة إشعارات**: إشعارات للعروض الجديدة القريبة
4. **تحسين الخوارزمية**: تحسين طريقة حساب المسافة والتصفية

## ملاحظات تقنية

- يتم استخدام `geolocator` للحصول على الموقع
- يتم استخدام `getNearRestaurants()` لجلب المطاعم القريبة
- يتم التحقق من `coupon.valid` و `coupon.discount` لتحديد العروض الصالحة
- يتم ترتيب النتائج باستخدام `distance` property
- **إصلاح المسافة**: تم تحويل المسافة من متر إلى كيلومتر (قسمة على 1000)
- **المرونة**: إذا لم توجد عروض أو متاجر محددة، يتم عرض جميع المطاعم القريبة

## الإصلاحات المطبقة

### 1. إصلاح حساب المسافة
```dart
distance: (double.tryParse(jsonMap!['distance'].toString()) ?? 0.0) / 1000.0
```
- تم تحويل المسافة من متر إلى كيلومتر

### 2. تحسين معايير التصفية
- **للمتاجر**: إضافة كلمات "shop", "market", "supermarket"
- **للعروض**: إضافة معيار `hasAnyCoupon` لعرض المطاعم التي لديها أي نوع من الكوبونات

### 3. المرونة في العرض
- إذا لم توجد متاجر محددة، يتم عرض جميع المطاعم القريبة
- إذا لم توجد عروض، يتم عرض جميع المطاعم القريبة
- تحسين الرسائل والعناوين حسب نوع البيانات المتوفرة

### 4. تحسين الـ Logs
- إضافة تفاصيل شاملة لكل مطعم للتصحيح
- طباعة المسافات والخصائص لكل مطعم

## اختبار التطبيق

لتشغيل التطبيق واختبار التغييرات:

```bash
cd /Users/hassanelhallaq/Desktop/Jetak-mobile-client-develop
flutter run
```

يجب أن تظهر العروض القريبة في قسم "offers near you" بناءً على موقع المستخدم والمسافة.
